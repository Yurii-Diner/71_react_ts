import { useState, type ChangeEvent, useEffect } from "react";

import axios from "axios";

import { Lesson11Wrapper, ImagesContainer, ControlsWrapper, ImageItem, Spinner} from "./styles";

import Button from "components/Button/Button";


function Lesson11(){

    // State это локальное хранилище данных внутри компонента, которое может изменяться со временем 
    // и влияет на его внешний вид и поведение. Например, это может быть значение из поля ввода, счетчик или 
    // информация о том, открыто ли модальное окно. Когда state меняется, React автоматически перерисовывает 
    // компонент, чтобы показать обновленные данные. 

    // State для хранения массива юрл изображений
    const [images, setImages] = useState<string[]>([]);

    // Stateт для ошибок
    const [error, setError] = useState<string | undefined>(undefined);

    // State для состояния загрузки
    const [isLoading, setIsLoading] = useState<boolean>(false);

    // Функция для получения случайного изображения животного
    // --------------------------------------------------------
    // Объявление асинхронной функции:
    // const fetchAnimalImage - создание константы с именем функции
    // async - ключевое слово, указывающее что функция асинхронная и будет содержать await
    // () => - стрелочная функция без параметров
    const fetchAnimalImage = async () => {

        // Установка состояния загрузки:
        // setIsLoading - функция setter из useState для управления состоянием загрузки
        // true - указывает что начался процесс загрузки данных
        // Цель: показать пользователю что данные загружаются (например, отобразить спиннер)
        setIsLoading(true);

        // Очистка предыдущих ошибок:
        // setError - функция setter из useState для управления ошибками
        // undefined - сбрасывает значение ошибки
        // Цель: убрать сообщения об ошибках от предыдущих запросов перед новым запросом
        setError(undefined);

        // Начало блока try-catch:
        // try - начало блока кода, в котором может произойти ошибка
        // Цель: обработать возможные ошибки без падения приложения
        try {
         
        // HTTP GET запрос:
        // await - приостанавливает выполнение функции до получения ответа
        // axios.get() - метод библиотеки axios для выполнения GET запроса
        // "https://dog.ceo/api/breeds/image/random" - API endpoint для получения случайного изображения собаки
        // const response - сохранение ответа от сервера в переменную
        // Возвращаемая структура:
        //   {
        //     "status": "success",
        //     "message": "https://images.dog.ceo/breeds/.../image.jpg"
        //   }
        const response = await axios.get("https://dog.ceo/api/breeds/image/random");


        // Извлечение URL изображения:
        // response.data - доступ к данным ответа от axios
        // .message - получение свойства message из ответа API (содержит URL изображения)
        // const imageUrl - сохранение URL в переменную для дальнейшего использования
        const imageUrl = response.data.message;
        
        // Добавляем новое изображение в массив (под предыдущими)
        // --------------------------------------------------------
        // Обновление состояния с изображениями:
        // setImages - функция setter из useState для массива изображений
        // prevImages => - использование функциональной формы setState для доступа к текущему состоянию
        // [...prevImages, imageUrl] - создание нового массива:
        // ...prevImages - spread оператор, копирует все существующие изображения
        // , imageUrl - добавляет новое изображение в конец массива
        // Иммутабельное обновление: создается новый массив вместо мутации существующего
        setImages(prevImages => [...prevImages, imageUrl]);

        // Обработка ошибок:
        // catch - блок выполняется если в try блоке произошла ошибка
        // (error: any) - параметр error с типом any (в TypeScript)
        // error - объект ошибки содержащий информацию о проблеме
        } catch (error: any) {

        // Установка сообщения об ошибке:
        // setError - функция для установки состояния ошибки
        // error.message - получение текстового сообщения об ошибке из объекта error
        // Примеры сообщений: "Network Error", "Request failed with status code 404" и т.д.
           setError(error.message);
        
        //  Блок finally:
        //  Выполняется в любом случае - независимо от успеха или ошибки в try-catch
        //  Цель: выполнить код который должен запуститься в любом сценарии
        } finally {

        // Блок finally:
        // Выполняется в любом случае - независимо от успеха или ошибки в try-catch
        // Цель: выполнить код который должен запуститься в любом сценарии
            setIsLoading(false);
        }


        //         Полный цикл работы функции:
        // Начало: Устанавливается загрузка, очищаются ошибки
        // Запрос: Отправляется HTTP запрос к API
        // Успех: Новое изображение добавляется в массив
        // Ошибка: Сообщение об ошибке сохраняется в state
        // Завершение: Индикатор загрузки убирается в любом случае

    };

    
    // Функция для удаления всех изображений
    const deleteAllImages = () => {
        setImages([]);
        setError(undefined);
    };

    // Эффект для загрузки первого изображения при монтировании компонента
    useEffect(() => {
        fetchAnimalImage();
    }, []);

return (

    <Lesson11Wrapper>

    {/* Блок с изображениями с фиксированной высотой и скроллом */}
    {/* Значение true, когда в массиве images есть хотя бы одно изображение */}
      <ImagesContainer $hasImages={images.length > 0}>
        {/* $ в начале имени пропса указывает, что это временный проп (transient prop) */}
        

        {/* Условный рендеринг спиннера:
          Рендеринг это процесс, при котором браузер преобразует код JavaScript в интерактивный контент на 
          веб-странице.
          isLoading && - если isLoading равно true, то отображается компонент справа
          <Spinner /> - компонент анимации загрузки*/}
        {isLoading && <Spinner />}
        
        {/* Условный рендеринг ошибки:
          error && - если error существует (не undefined/null), отображается блок ошибки
         <div>Error: {error}</div> - div с текстом ошибки, где {error} подставляется значение из state */}
        {error && <div>Error: {error}</div>}
        

        {/* Отображение всех полученных изображений */}
        {/* --------------------------------------- */}
        {/* Маппинг массива изображений: */}
        {/* images.map - перебирает массив images и для каждого элемента возвращает JSX */}
        {/* (imageUrl, i) - параметры callback-функции: */}
        {/* imageUrl - URL изображения (текущий элемент массива) */}
        {/* i - индекс текущего элемента в массиве */}
        {images.map((imageUrl, index) => (
        
        // ImageItem - стилизованный компонент для отдельного изображения
          <ImageItem 

        // Ключ для React:
        // Обязательный атрибут при рендере списков
        // {imageUrl}-${index} - создает уникальный ключ из URL и индекса
        // Нужен React для эффективного обновления DOM при изменениях списка
            key={`${imageUrl}-${index}`}


        // Атрибут src тега img:
        // Указывает источник изображения
        // {imageUrl} - подставляет URL из массива images
             src={imageUrl}

        // Aльтернативный текст:
        // alt - атрибут для доступности (screen readers) и SEO
        // Dog ${index + 1} - генерирует текст вида "Dog 1", "Dog 2" и т.д.
        // index + 1 - чтобы нумерация начиналась с 1, а не с 0
        // alt={`Animal ${index + 1}`} 
          />

        ))}

      </ImagesContainer>

        <ControlsWrapper>

            {/* Кнопка для получения дополнительных изображений */}
            <Button name="GET MORE IMAGES" onClick={fetchAnimalImage} disabled={isLoading} />
            
            {/* Кнопка удаления всех данных (показывается только когда есть изображения) */}
            {images.length > 0 && (
              <Button name="DELETE ALL DATA" onClick={deleteAllImages} />
            )}

        </ControlsWrapper>

    </Lesson11Wrapper>
  );
}

export default Lesson11;